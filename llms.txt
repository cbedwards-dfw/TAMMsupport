# TAMMsupport

The goal of [TAMMsupport](https://framverse.r-universe.dev/TAMMsupport)
is to provide R-based tools for working with and interpreting Terminal
Area Management Module files
(<https://framverse.github.io/fram_doc/calcs_glossary.html#Terminal_Area_Management_Module_(TAMM)>).

[TAMMsupport](https://framverse.r-universe.dev/TAMMsupport) is part of
the [“framverse” R universe of
packages](https://framverse.r-universe.dev/packages).

## Cheatsheet

I want to…

- Summarize and visualize key aspects of a Chinook TAMM? Use
  [`tamm_report()`](https://cbedwards-dfw.github.io/TAMMsupport/reference/tamm_report.md).
- compare two Chinook TAMM files to look for changes in inputs or
  results? Use
  [`tamm_diff()`](https://cbedwards-dfw.github.io/TAMMsupport/reference/tamm_diff.md).
  (Comparing Coho TAMM files is currently supported, but does not
  replicate Coho TAMM formatting)
- compare two or more Chinook TAMM files (e.g. look across three ocean
  options) to see how ER varies by stock and fishery between the models?
  Use
  [`tamm_compare()`](https://cbedwards-dfw.github.io/TAMMsupport/reference/tamm_compare.md).
- extract the overview sheet info from a Chinook TAMM? Use
  [`read_overview()`](https://cbedwards-dfw.github.io/TAMMsupport/reference/read_overview.md)
  or
  [`read_overview_complete()`](https://cbedwards-dfw.github.io/TAMMsupport/reference/read_overview_complete.md).
- extract the limiting stock complete sheet from a Chinook TAMM? Use
  [`read_limiting_stock()`](https://cbedwards-dfw.github.io/TAMMsupport/reference/read_limiting_stock.md)
  or
  [`clean_limiting_stock()`](https://cbedwards-dfw.github.io/TAMMsupport/reference/clean_limiting_stock.md).
  If desired, use
  [`filter_tamm_wa()`](https://cbedwards-dfw.github.io/TAMMsupport/reference/filter_tamm_wa.md)
  to then filter the results to just Washington fisheries.
- Trace the network of cells used by a formula in a TAMM (or other excel
  file)? Use
  [`trace_formula()`](https://cbedwards-dfw.github.io/TAMMsupport/reference/trace_formula.md)
  to generate a dependency network, and
  [`make_tracer_network()`](https://cbedwards-dfw.github.io/TAMMsupport/reference/make_tracer_network.md)
  to visualize it.

## Installation

You can install the compiled version of
[TAMMsupport](https://framverse.r-universe.dev/TAMMsupport) through the
R-universe package repository:

``` r
install.packages("TAMMsupport", repos = "https://framverse.r-universe.dev")
```

If you have RTools installed, you can also install the development
version of TAMMsupport with [devtools](https://devtools.r-lib.org/) like
so:

``` r
devtools::install_github("cbedwards-dfw/TAMMsupport")    
```

or with [pak](https://pak.r-lib.org/) like so:

``` r
pak::pkg_install("cbedwards-dfw/TAMMsupport")
```

`TAMMsupport` depends on the `xldiff` package, which contains our
general tools for comparing excel files using R. `xldiff` should
automatically be installed when `TAMMsupport` is. `xldiff` and its
documentation can be found here:
<https://github.com/cbedwards-dfw/xldiff>.

With `TAMMsupport` installed, we can use functions from it by including
the library in our script, like so:

``` r
library(TAMMsupport)
```

## `tamm_diff()`

[`tamm_diff()`](https://cbedwards-dfw.github.io/TAMMsupport/reference/tamm_diff.md)
facilitates comparing the outputs and inputs of two tamm files by
identifying changes in cell values in the overview, limiting stock
complete, and input sheets. `tamm_diff` then creates a “diff” excel file
that contains the contents of those three sheets, highlighting the
changed cells. The formatting of the diff file broadly reflects that of
the Chinook TAMM, but with simpler border and highlighting choices.

[`tamm_diff()`](https://cbedwards-dfw.github.io/TAMMsupport/reference/tamm_diff.md)
takes three arguments: the names of the first TAMM file, the second tamm
file, and the name to give the resulting file (in all cases, the name
should include filepath, if relevant). All three filenames should end in
“.xlsx”. The following is an example use:

``` r
cur.wd = getwd()
setwd("C:/Users/edwc1477/OneDrive - Washington State Executive Branch Agencies/Documents/WDFW FRAM team work/NOF material/NOF 2024")

tamm_diff(filename.1 = "FRAM/Chin1124.xlsx",
          filename.2 = "NOF 2/Chin2524.xlsx",
          results.name = "comparison of Chin 1124 vs 2524.xlsx"
)

setwd(cur.wd)
```

By default,
[`tamm_diff()`](https://cbedwards-dfw.github.io/TAMMsupport/reference/tamm_diff.md)
rounds percents and numbers of fish to the nearest 0.1 (1 decimal place)
before comparing, and rounds numbers that are expected to be longer
decimanls (e.g. rates, proportions) to the nearest 0.0001 (4 decimal
places). In some cases, we may want to solely focus on larger changes
(e.g. changes in whole fish). The optional arguments `percent_digits`,
`numeric.digits` and `numeric.digits.small` control the decimal place
rounding for percents, numbers of fish, and numbers that are expected to
be rates or proportions, respectively. To highlight only larger changes,
we might use

``` r
tamm_diff(filename.1 = "FRAM/Chin1124.xlsx",
          filename.2 = "NOF 2/Chin2524.xlsx",
          results.name = "comparison of Chin 1124 vs 2524.xlsx",
          percent_digits = 1, numeric.digits = 0, numeric.digits.small = 3
)
```

Note that since we typically manage ER to the nearest 0.1%, it is
unlikely that a percent_digits value of 0 would be useful.

Currently
[`tamm_diff()`](https://cbedwards-dfw.github.io/TAMMsupport/reference/tamm_diff.md)
only works well when comparing Chinook TAMM files. Comparison of Coho
TAMM files is in development – the comparison itself works, but the
output file does not replicate the formatting of the Coho TAMM, which
makes reading the file unpleasant.

## Working with limiting stock sheet

[`read_limiting_stock()`](https://cbedwards-dfw.github.io/TAMMsupport/reference/read_limiting_stock.md)
reads in the limiting stock sheet of a TAMM file and applies some
minimal formatting and filtering (notably, combining into a single table
with variable `stock_type` to distingish hatchery and natural, unmarked
and natural; giving categorization of fisheries).

[`clean_limiting_stock()`](https://cbedwards-dfw.github.io/TAMMsupport/reference/clean_limiting_stock.md)
does everything read_limiting stock does, but then filters to unmarked
naturals, filters out AEQ entries, and provides the results in a
long-form table that is ready for plotting or analysis of exploitation
rates.

`filter_tamm_wa` filters a limiting stock dataframe (e.g. the output of
`read_limiting_stock or` `clean_limiting_stock`) to just Washington
fisheries. `filter_tamm_wa` looks for a `species` attribute in the
dataframe (in line with This function can be included in a pipe,
consistent with the filtering approaches in the `framrsquared package`.
Unless you add that attribute to your data frame, it makes more sense to
call
[`filter_tamm_wa_chin()`](https://cbedwards-dfw.github.io/TAMMsupport/reference/filter_tamm_wa.md)
(for chinook TAMMs) or
[`filter_tamm_wa_coho()`](https://cbedwards-dfw.github.io/TAMMsupport/reference/filter_tamm_wa.md)
(for Coho tamms)

``` r
library(ggplot2)
library(dplyr)
clean_limiting_stock("Chin1224.xlsx") |> 
  filter_tamm_wa_chin() |> 
  filter(timestep == "yr")
  ggplot(aes(x = stock, y = er, fill = Fishery))+
    geom_bar(position="stack", stat="identity")
```

## Tools in development

These tools are functional, but still being developed.

### `tamm_report()`

[`tamm_report()`](https://cbedwards-dfw.github.io/TAMMsupport/reference/tamm_report.md)
summarizes key aspects of a single Chinook TAMM file in an html report,
which is generated in the same folder as the summarized TAMM.

Under the hood, tamm_report() uses a template parameterized quarto
report and a child quarto file to help automate the creation of tabs for
each stock. To see the underlying quarto files used (e.g., to suggest
additional edits or features), set argument `clean = FALSE` when calling
[`tamm_report()`](https://cbedwards-dfw.github.io/TAMMsupport/reference/tamm_report.md).
This will prevent the deletion of `tamm-visualizer.qmd` and
`tamm-visualizer-child.qmd`, which will be present in the same folder as
the TAMM and report.

Future goals include

- workshopping and adding additional summary information based on user
  needs

### `tamm_compare()`

[`tamm_compare()`](https://cbedwards-dfw.github.io/TAMMsupport/reference/tamm_compare.md)
uses the same general approach as
[`tamm_report()`](https://cbedwards-dfw.github.io/TAMMsupport/reference/tamm_report.md),
but creates a report to compare any number TAMM files based off of Yi
Xu’s Rmarkdown report to compare exploitation rates for three ocean
options. The optional argument `fisheries` takes a numeric vector of
fishery IDs; visualization of stock ERs will only plot those ERs. If
`fisheries` is not provided, for each stock
[`tamm_compare()`](https://cbedwards-dfw.github.io/TAMMsupport/reference/tamm_compare.md)
will create a figure of impacts from all fisheries, and a separate plot
of impacts from all SUS fisheries.

## Stock, Fishery, and Timestep tables

FRAM and TAMM often use stock ID number, fishery ID number, and time
step number to represent stock, fishery, and timestep respectively.
TAMMsupport includes dataframe versions of the `Stock`, `Fishery`, and
`TimeStep` tables of the Coho and Chinook FRAM databases for easy
reference and to streamline merging human-readable names to dataframes
that have only id numbers. These dataframes are named
`fishery_chinook_fram`, `fishery_coho_fram`, `stock_chinook_fram`,
`stock_coho_fram`, `timestep_chinook_fram`, and `timestep_coho_fram`,
and have associated help files accessible with `?fishery_chinook_fram`
etc. The initial rows of these dataframes are shown below.

### `stock_chinook_fram`

``` r
knitr::kable(head(TAMMsupport::stock_chinook_fram, 5))
```

| species | stock_version | stock_id | production_region_number | management_unit_number | stock_name  | stock_long_name                |
|:--------|--------------:|---------:|-------------------------:|-----------------------:|:------------|:-------------------------------|
| CHINOOK |             5 |        4 |                        1 |                      6 | M-NK Sp Hat | Marked Nooksack Spr Hatchery   |
| CHINOOK |             5 |        6 |                        1 |                     10 | M-NK Sp Nat | Marked Nooksack Spr Natural    |
| CHINOOK |             5 |        8 |                        2 |                      2 | M-Skag FF   | Marked Skagit Summer/Fall Fing |
| CHINOOK |             5 |       10 |                        2 |                      6 | M-SkagFYr   | Marked Skagit Summer/Fall Year |
| CHINOOK |             5 |       12 |                        2 |                     10 | M-SkagSpY   | Marked Skagit Spring Year      |

### `stock_coho_fram`

``` r
knitr::kable(head(TAMMsupport::stock_coho_fram, 5))
```

| species | stock_version | stock_id | production_region_number | management_unit_number | stock_name | stock_long_name                 |
|:--------|--------------:|---------:|-------------------------:|-----------------------:|:-----------|:--------------------------------|
| COHO    |             1 |        1 |                        1 |                      1 | U-nkskrw   | Nooksack River Wild UnMarked    |
| COHO    |             1 |        2 |                        1 |                      2 | M-nkskrw   | Nooksack River Wild Marked      |
| COHO    |             1 |        3 |                        1 |                      3 | U-kendlh   | Kendall Creek Hatchery UnMarked |
| COHO    |             1 |        4 |                        1 |                      4 | M-kendlh   | Kendall Creek Hatchery Marked   |
| COHO    |             1 |        5 |                        1 |                      5 | U-skokmh   | Skookum Creek Hatchery UnMarked |

### `fishery_chinook_fram`

``` r
knitr::kable(head(TAMMsupport::fishery_chinook_fram, 5))
```

| species | version_number | fishery_id | fishery_name | fishery_title     |
|:--------|---------------:|-----------:|:-------------|:------------------|
| CHINOOK |              1 |         55 | Tr 6B:9Net   | Tr Area 6B:9 Net  |
| CHINOOK |              1 |         56 | A 10 Sport   | NT Area 10 Sport  |
| CHINOOK |              1 |         57 | A 11 Sport   | NT Area 11 Sport  |
| CHINOOK |              1 |         58 | NT10:11Net   | NT Area 10:11 Net |
| CHINOOK |              1 |         59 | Tr10:11Net   | Tr Area 10:11 Net |

### `fishery_coho_fram`

``` r
knitr::kable(head(TAMMsupport::fishery_coho_fram, 5))
```

| species | version_number | fishery_id | fishery_name | fishery_title               |
|:--------|---------------:|-----------:|:-------------|:----------------------------|
| COHO    |              1 |          1 | No Cal Trm   | No Calif Cst Terminal Catch |
| COHO    |              1 |          2 | Cn Cal Trm   | Cntrl Cal Cst Term Catch    |
| COHO    |              1 |          3 | Ft Brg Spt   | Fort Bragg Sport            |
| COHO    |              1 |          4 | Ft Brg Trl   | Fort Bragg Troll            |
| COHO    |              1 |          5 | Ca KMZ Spt   | KMZ Sport                   |

### `timestep_chinook_fram`

``` r
knitr::kable(head(TAMMsupport::timestep_chinook_fram, 5))
```

| species | version_number | time_step_id | time_step_name | time_step_title  |
|:--------|---------------:|-------------:|:---------------|:-----------------|
| CHINOOK |              1 |            1 | Oct-Apr        | October-April    |
| CHINOOK |              1 |            2 | May-June       | May - June       |
| CHINOOK |              1 |            3 | July-Sept      | July - September |
| CHINOOK |              1 |            4 | Oct-Apr-2      | October-April-2  |

### `timestep_coho_fram`

``` r
knitr::kable(head(TAMMsupport::timestep_coho_fram, 5))
```

| species | version_number | time_step_id | time_step_name | time_step_title    |
|:--------|---------------:|-------------:|:---------------|:-------------------|
| COHO    |              1 |            1 | Jan-Jun        | January - June     |
| COHO    |              1 |            2 | July           | July               |
| COHO    |              1 |            3 | August         | August             |
| COHO    |              1 |            4 | Septmbr        | September          |
| COHO    |              1 |            5 | Oct-Dec        | October - December |

# Package index

## All functions

- [`address_parser()`](https://cbedwards-dfw.github.io/TAMMsupport/reference/address_parser.md)
  : Parse excel address including sheet

- [`as_numeric_safe()`](https://cbedwards-dfw.github.io/TAMMsupport/reference/as_numeric_safe.md)
  : Safely convert character numerics into numeric

- [`chunk_formater_percenter()`](https://cbedwards-dfw.github.io/TAMMsupport/reference/chunk_formater_percenter.md)
  : Format chunks of dataframe to present as %s, round digits

- [`chunk_formater_rounder()`](https://cbedwards-dfw.github.io/TAMMsupport/reference/chunk_formater_rounder.md)
  : Format chunks of dataframe to round digits

- [`chunk_read_2A_CUandM()`](https://cbedwards-dfw.github.io/TAMMsupport/reference/chunk_read_2A_CUandM.md)
  : Read chunk for table 2A_CUandM

- [`chunk_read_2A_CUandM_N()`](https://cbedwards-dfw.github.io/TAMMsupport/reference/chunk_read_2A_CUandM_N.md)
  : Read in individual chunks for sheet 2A_Cu&M_N

- [`chunk_read_2A_CUnmrkd()`](https://cbedwards-dfw.github.io/TAMMsupport/reference/chunk_read_2A_CUnmrkd.md)
  : Reads chunk of 2A_CUnmrkd sheet

- [`chunk_read_2A_Cmrkd()`](https://cbedwards-dfw.github.io/TAMMsupport/reference/chunk_read_2A_Cmrkd.md)
  : Read in chunks of the 2A_Cmrkd sheet

- [`chunk_read_finisher()`](https://cbedwards-dfw.github.io/TAMMsupport/reference/chunk_read_finisher.md)
  : Finishes a chunk after initial reading

- [`clean_limiting_stock()`](https://cbedwards-dfw.github.io/TAMMsupport/reference/clean_limiting_stock.md)
  : Generates clean read of TAMM limiting stock sheet

- [`compare_chinook_inputs()`](https://cbedwards-dfw.github.io/TAMMsupport/reference/compare_chinook_inputs.md)
  : Compare differences in input sheets of two TAMM files

- [`filter_tamm_wa()`](https://cbedwards-dfw.github.io/TAMMsupport/reference/filter_tamm_wa.md)
  [`filter_tamm_wa_chin()`](https://cbedwards-dfw.github.io/TAMMsupport/reference/filter_tamm_wa.md)
  [`filter_tamm_wa_coho()`](https://cbedwards-dfw.github.io/TAMMsupport/reference/filter_tamm_wa.md)
  : Filters a dataframe to Washington State fisheries.

- [`find_color_matches()`](https://cbedwards-dfw.github.io/TAMMsupport/reference/find_color_matches.md)
  : Identify all cells in Excel sheet or sheets with matching cell
  colors

- [`fishery_renamer()`](https://cbedwards-dfw.github.io/TAMMsupport/reference/fishery_renamer.md)
  : relabel inconsistent fishery names in FRAM/TAMM

- [`format_key_tamm_sheets_chin()`](https://cbedwards-dfw.github.io/TAMMsupport/reference/format_key_tamm_sheets_chin.md)
  :

  **\[superseded\]** Modify list of Chinook TAMM spreadsheet dataframes
  to facilitate comparison.

- [`format_key_tamm_sheets_coho()`](https://cbedwards-dfw.github.io/TAMMsupport/reference/format_key_tamm_sheets_coho.md)
  : Modify list of Coho TAMM spreadsheet dataframes to facilitate
  comparison.

- [`format_overview()`](https://cbedwards-dfw.github.io/TAMMsupport/reference/format_overview.md)
  : Format TAMM overview for easy printing

- [`formula_formater()`](https://cbedwards-dfw.github.io/TAMMsupport/reference/formula_formater.md)
  : Add spaces to excel formulas for readability

- [`fun_percenter()`](https://cbedwards-dfw.github.io/TAMMsupport/reference/fun_percenter.md)
  : Format vector of mixed characters to present numbers as percents

- [`fun_rounder()`](https://cbedwards-dfw.github.io/TAMMsupport/reference/fun_rounder.md)
  : Format vector of mixed characters to round numbers to specified
  digits

- [`kable_overview()`](https://cbedwards-dfw.github.io/TAMMsupport/reference/kable_overview.md)
  : Print table of overview using kable and kableExtra

- [`make_tracer_edges()`](https://cbedwards-dfw.github.io/TAMMsupport/reference/make_tracer_edges.md)
  : Calculate and format edges from traced objects

- [`make_tracer_network()`](https://cbedwards-dfw.github.io/TAMMsupport/reference/make_tracer_network.md)
  **\[experimental\]** : Visualize excel formula tracing

- [`make_tracer_nodes()`](https://cbedwards-dfw.github.io/TAMMsupport/reference/make_tracer_nodes.md)
  : List cells and contents from traced objects

- [`process_2ac_aeqs()`](https://cbedwards-dfw.github.io/TAMMsupport/reference/process_2ac_aeqs.md)
  **\[experimental\]** :

  **\[experimental\]** Read and combine aeq sections form tables 2a-2c

- [`process_2ac_ers()`](https://cbedwards-dfw.github.io/TAMMsupport/reference/process_2ac_ers.md)
  **\[experimental\]** :

  **\[experimental\]** function to process + combine the er sections
  from tables 2a-2c, used below

- [`quick_er_format()`](https://cbedwards-dfw.github.io/TAMMsupport/reference/quick_er_format.md)
  : Quick helper function to format vectors that contain text and ERs

- [`range_splitter()`](https://cbedwards-dfw.github.io/TAMMsupport/reference/range_splitter.md)
  : Translate excel-style cell range to vector of cell addresses.

- [`read_2aCUandM()`](https://cbedwards-dfw.github.io/TAMMsupport/reference/read_2aCUandM.md)
  : Read and process all parts of sheet 2A CU and M

- [`read_2aCUandM_N()`](https://cbedwards-dfw.github.io/TAMMsupport/reference/read_2aCUandM_N.md)
  : Read and combine all chunks for sheet 2A CU and M_N

- [`read_2aCUnmrkd()`](https://cbedwards-dfw.github.io/TAMMsupport/reference/read_2aCUnmrkd.md)
  : read all info for 2aCUnmrkd and process it.

- [`read_2aCmrkd()`](https://cbedwards-dfw.github.io/TAMMsupport/reference/read_2aCmrkd.md)
  : Reads sheet of 2A_Cmrkd

- [`read_2a_sheets()`](https://cbedwards-dfw.github.io/TAMMsupport/reference/read_2a_sheets.md)
  : Read and combine all 2a sheets from a TAMM file

- [`read_jdf()`](https://cbedwards-dfw.github.io/TAMMsupport/reference/read_jdf.md)
  : Read in AEQ and ER information from the JDF sheet

- [`read_key_tamm_sheets_chin()`](https://cbedwards-dfw.github.io/TAMMsupport/reference/read_key_tamm_sheets_chin.md)
  : Read Chinook TAMM files to extract the key sheets

- [`read_key_tamm_sheets_coho()`](https://cbedwards-dfw.github.io/TAMMsupport/reference/read_key_tamm_sheets_coho.md)
  : Read Chinook TAMM files to extract the key sheets

- [`read_limiting_stock()`](https://cbedwards-dfw.github.io/TAMMsupport/reference/read_limiting_stock.md)
  : Read TAMM limiting stock complete tab

- [`read_management_chin()`](https://cbedwards-dfw.github.io/TAMMsupport/reference/read_management_chin.md)
  : Extract and format management criterion from Chinook TAMM

- [`read_overview()`](https://cbedwards-dfw.github.io/TAMMsupport/reference/read_overview.md)
  : Read overview sheet from TAMM and return key stock

- [`read_overview_complete()`](https://cbedwards-dfw.github.io/TAMMsupport/reference/read_overview_complete.md)
  : Read overview sheet from TAMM and return all stock

- [`read_tnt_allocation_chin()`](https://cbedwards-dfw.github.io/TAMMsupport/reference/read_tnt_allocation_chin.md)
  :

  **\[experimental\]**

- [`reformat_management()`](https://cbedwards-dfw.github.io/TAMMsupport/reference/reformat_management.md)
  : Convenience function for formatting TAMM management criterion chunks

- [`safe_convert_numeric()`](https://cbedwards-dfw.github.io/TAMMsupport/reference/safe_convert_numeric.md)
  : Convert string of number to numeric

- [`tamm_compare()`](https://cbedwards-dfw.github.io/TAMMsupport/reference/tamm_compare.md)
  : Generate summary comparison of any number of TAMM files

- [`tamm_compare3()`](https://cbedwards-dfw.github.io/TAMMsupport/reference/tamm_compare3.md)
  : Generate summary comparison of 3 TAMM files

- [`tamm_diff()`](https://cbedwards-dfw.github.io/TAMMsupport/reference/tamm_diff.md)
  : Compare key sheets of TAMM files

- [`tamm_format_overview()`](https://cbedwards-dfw.github.io/TAMMsupport/reference/tamm_format_sheets.md)
  [`tamm_format_limiting()`](https://cbedwards-dfw.github.io/TAMMsupport/reference/tamm_format_sheets.md)
  [`tamm_format_input()`](https://cbedwards-dfw.github.io/TAMMsupport/reference/tamm_format_sheets.md)
  [`tamm_format_wacoast()`](https://cbedwards-dfw.github.io/TAMMsupport/reference/tamm_format_sheets.md)
  : Apply final formatting to diff'd TAMM sheets

- [`tamm_report()`](https://cbedwards-dfw.github.io/TAMMsupport/reference/tamm_report.md)
  : Generate report of figures from TAMM file

- [`trace_formula()`](https://cbedwards-dfw.github.io/TAMMsupport/reference/trace_formula.md)
  **\[experimental\]** : Trace the calculations of a cell recursively
  through all referenced cells

- [`validate_data_frame()`](https://cbedwards-dfw.github.io/TAMMsupport/reference/validate_data_frame.md)
  : Confirm object is dataframe

